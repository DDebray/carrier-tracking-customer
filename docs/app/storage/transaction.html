<!DOCTYPE html><html lang="en"><head><title>app/storage/transaction</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="app/storage/transaction"><meta name="groc-project-path" content="assets/js/app/storage/transaction.js"><meta name="groc-github-url" content="https://github.com/zooron/carrier-tracking-customer"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/zooron/carrier-tracking-customer/blob/master/assets/js/app/storage/transaction.js">assets/js/app/storage/transaction.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-built_in">module</span>.exports = [
  <span class="hljs-string">'$q'</span>, <span class="hljs-string">'CommonUi'</span>, <span class="hljs-string">'CommonRequest'</span>, <span class="hljs-string">'CommonPopups'</span>,
  <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">
    $q, CommonUi, CommonRequest, CommonPopups
  </span>) </span>{
<span class="hljs-pi">    'use strict'</span>;

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> of type <em>Object</em></span></p>
<p>This private object holds the
possible request parameters.</p></div></div><div class="code"><div class="wrapper">      requestParameters = {
        updated_address: <span class="hljs-literal">null</span>,
        tracking_number: <span class="hljs-literal">null</span>,
        postal_code_for_verification: <span class="hljs-literal">null</span>,
        selected_rate_code: <span class="hljs-literal">null</span>,
        payment_method: <span class="hljs-literal">null</span>,
        iban: <span class="hljs-literal">null</span>,
        bic: <span class="hljs-literal">null</span>
      };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> of type <em>[type]</em></span></p>
<p>This public object holds
the selected rate.</p></div></div><div class="code"><div class="wrapper">    self.selectedRate = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> of type <em>[type]</em></span></p>
<p>This public object holds
the selected payment method.</p></div></div><div class="code"><div class="wrapper">    self.selectedMethod = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> of type <em>Object</em></span></p>
<p>This public method holds the information
of all possible payment method.</p></div></div><div class="code"><div class="wrapper">    self.methods = {
      CREDIT_CARD: {
        data: <span class="hljs-literal">null</span>
      },
      PAYPAL: {
        data: <span class="hljs-literal">null</span>
      },
      SOFORT_UEBERWEISUNG: {
        data: <span class="hljs-literal">null</span>
      }
    };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> of type <em>Object</em></span></p>
<p>This public object holds the callback
for the comming popup events.</p></div></div><div class="code"><div class="wrapper">    self.transactionCallback = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>This function opens the popup for the payment process
and starts the transaction.</p>
<p>Parameters:</p>
<ul>
<li><strong>trackingId must be a String.</strong><br/>(a string holding the tracking number.)</li>
</ul></div></div><div class="code"><div class="wrapper">    self.start = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">trackingId, postalCodeForVerification</span>) </span>{
      <span class="hljs-keyword">if</span> (!self.transactionCallback) {
        <span class="hljs-keyword">return</span>;
      }

      requestParameters.updated_address = self.updatedAddress;
      requestParameters.selected_rate_code = self.selectedRate.code;
      requestParameters.payment_method = self.selectedMethod;
      requestParameters.tracking_number = trackingId;
      requestParameters.postal_code_for_verification = postalCodeForVerification;

      <span class="hljs-keyword">if</span> (self.methods[self.selectedMethod].data) {
        requestParameters.iban = self.methods[self.selectedMethod].data.iban;
        requestParameters.bic = self.methods[self.selectedMethod].data.bic;
      }

      openPopup();
    };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This function handles all popup related actions.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> openPopup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

      <span class="hljs-keyword">var</span> newPopupFactory,
        popupPromise = $q.resolve();

      newPopupFactory = CommonPopups();
      popupPromise = newPopupFactory.prepare();

      popupPromise.then(</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>POPUP SUCCESSFULLY OPENED</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          CommonRequest.transaction.start({
              parameters: requestParameters
            },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>START TRANSACTION REQUEST WAS SUCCESSFULL</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
              (newPopupFactory ? newPopupFactory.proceed((response.content || {}).redirect_url) : $q.resolve()).then(</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>PAYMENT PROCESS WAS SUCCESSFULL</p></div></div><div class="code"><div class="wrapper">                <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
                  <span class="hljs-keyword">var</span> downloads = {};
                  <span class="hljs-keyword">if</span> (response.data.data.content) {
                    downloads = response.data.data.content.result;
                  } <span class="hljs-keyword">else</span> {
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'TODO: check PayPal data'</span>, response.data.data);
                  }
                  self.transactionCallback(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, downloads);
                },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>PAYMENT PROCESS WAS NOT SUCCESSFULL</p></div></div><div class="code"><div class="wrapper">                <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Popup was closed or lost focus</p></div></div><div class="code"><div class="wrapper">                  <span class="hljs-keyword">if</span> (newPopupFactory) {
                    newPopupFactory.proceed(<span class="hljs-literal">false</span>);
                  }
                  <span class="hljs-keyword">if</span> (response) {
                    self.transactionCallback(<span class="hljs-literal">true</span>, (response.messages.length &gt; <span class="hljs-number">0</span>) ? response.messages : <span class="hljs-literal">false</span>);
                  }
                }
              );

            },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>START TRANSACTION REQUEST WAS NOT SUCCESSFULL</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
              self.transactionCallback(<span class="hljs-literal">true</span>);
            });
        },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>POPUP NOT SUCCESSFULLY OPENED</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          self.transactionCallback(<span class="hljs-literal">true</span>);
        });
    };

    <span class="hljs-keyword">return</span> self;
  }
];</div></div></div></div></body></html>