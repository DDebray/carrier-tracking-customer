<!DOCTYPE html><html lang="en"><head><title>app/common/popups</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="app/common/popups"><meta name="groc-project-path" content="assets/js/app/common/popups.js"><meta name="groc-github-url" content="https://github.com/zooron/carrier-tracking-customer"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/zooron/carrier-tracking-customer/blob/master/assets/js/app/common/popups.js">assets/js/app/common/popups.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-built_in">module</span>.exports = [
  <span class="hljs-string">'$q'</span>,
<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
  $q
</span>) </span>{
<span class="hljs-pi">  'use strict'</span>;

  <span class="hljs-keyword">var</span> popups = angular.extend({}, {
    prepare : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">again</span>) </span>{
      <span class="hljs-keyword">if</span> (!again) {
        <span class="hljs-keyword">this</span>.deferred = $q.defer();
      }

      <span class="hljs-keyword">var</span> _width = (screen.availWidth * <span class="hljs-number">0.8</span>),
        _height = (screen.availHeight * <span class="hljs-number">0.8</span>);

      <span class="hljs-keyword">this</span>.popup = <span class="hljs-built_in">window</span>.open(<span class="hljs-string">'/wait.html'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'width='</span> + _width + <span class="hljs-string">',height='</span> + _height + <span class="hljs-string">',resizable=yes'</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.popup) {
        <span class="hljs-keyword">this</span>.popup.moveTo(screen.availWidth * <span class="hljs-number">0.5</span>, screen.availHeight * <span class="hljs-number">0.5</span>);
        <span class="hljs-keyword">this</span>.popup.focus();
        <span class="hljs-keyword">this</span>.deferred.resolve();
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.prepare(<span class="hljs-literal">true</span>);
      }

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deferred.promise;
    },
    proceed : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">url</span>) </span>{
      <span class="hljs-keyword">this</span>.deferred = $q.defer();

      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.popup || !<span class="hljs-keyword">this</span>.popup.location) {
        <span class="hljs-keyword">return</span> $q.reject();
      }

      <span class="hljs-keyword">if</span> (!url) {
        <span class="hljs-keyword">this</span>.popup.close();
        <span class="hljs-keyword">return</span> $q.reject();
      }

      <span class="hljs-keyword">this</span>.popup.location.href = url;
      <span class="hljs-keyword">this</span>.sendMessage = <span class="hljs-built_in">window</span>.setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.popup.postMessage(<span class="hljs-string">'COUREON'</span>, <span class="hljs-string">'*'</span>);
      }.bind(<span class="hljs-keyword">this</span>), <span class="hljs-number">100</span>);

      <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">this</span>.receiveMessage.bind(<span class="hljs-keyword">this</span>), <span class="hljs-literal">false</span>);
      <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'focus'</span>, <span class="hljs-keyword">this</span>.finish.bind(<span class="hljs-keyword">this</span>));

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deferred.promise;
    },
    receiveMessage : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
      <span class="hljs-keyword">if</span> (e.data.origin !== <span class="hljs-string">'COUREON'</span>) {
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">if</span> (e.data.data &amp;&amp; e.data.data.messages &amp;&amp; e.data.data.messages.length &amp;&amp; e.data.data.messages[<span class="hljs-number">0</span>].text) {
          <span class="hljs-keyword">this</span>.deferred.reject(e.data.data.messages[<span class="hljs-number">0</span>]);
      }

      <span class="hljs-keyword">if</span> (e.data.data &amp;&amp; e.data.data.status === <span class="hljs-string">'OK'</span>) {
        <span class="hljs-keyword">this</span>.deferred.resolve(e);
      }

      <span class="hljs-keyword">this</span>.finish();
    },
    finish : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-built_in">window</span>.clearInterval(<span class="hljs-keyword">this</span>.sendMessage);
      <span class="hljs-built_in">window</span>.removeEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">this</span>.receiveMessage);
      <span class="hljs-built_in">window</span>.removeEventListener(<span class="hljs-string">'focus'</span>, <span class="hljs-keyword">this</span>.finish);

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.popup) {
        <span class="hljs-keyword">this</span>.popup.close();
      }

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.deferred.promise.$$state.status !== <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">this</span>.deferred.reject();
      }
    }
  });

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> popups;
  };
}];</div></div></div></div></body></html>